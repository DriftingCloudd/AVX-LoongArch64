# 总述
loongarch架构（龙架构）龙芯架构具有 RISC 指令架构的典型特征。它的指令长度固定且编码格式规整,绝大多数指令只有两个源操作数和一个目的操作数,采用 load/store 架构,即仅有 load/store 访存指令可以访问内存,其它指令的操作对象均是处理器核内部的寄存器或指令码中的立即数。

## 特权集架构
龙芯架构特权集使用4级，从PLV0 至 PLV3 。其中PLV0 表示核心态 ，一般使用PLV3表示用户态。从PLV1 至PLV3 的级别都不能执行**特权访问指令**，3者的区别体现在MMU映射地址翻译模式下权限不同。

PLV0级别可以对CSR（控制寄存器）进行读写操作，包括通用CSR，IOCSR，TLB和Cache的管理等。

IOCSR（IO控制寄存器）采用独立寻址空间，采用小尾端存储格式，采用直接地址映射方式，物理地址等于逻辑地址。

## 存储管理系统
>  仅记录移植过程中信息

## MMU
MMU（内存管理单元）支持2种地址翻译模式：直接地址翻译模式和映射地址翻译模式。
在直接地址映射模式下,物理地址默认直接等于虚拟地址的[PALEN-1:0]位(不足补 0)
,除非具体实现中采用了其它优先级更高的虚实地址翻译规则。此时整个虚拟地址空间都是合法的。处理器复位结束后将进入直接地址翻译模式。
映射地址翻译模式与传统的直接映射翻译和页表映射翻译的方式一致。

直接地址翻译模式下，系统通过DWM0->DWM3  配置窗口，DWM_MASK的作用是匹配对应的窗口；窗口的意义是限制权限和提高虚地址映射的大小。
- 前2个窗口用于load/store 和取值操作
- 后2个窗口只能用于 load/store 操作

由于内核启动时首先启动直接地址翻译模式，计算pa（物理地址）时均要使用DMW_MASK获取实际物理地址。

## 页表项
Loongarch架构的页表项设计为：虚双页号->2个物理页面。
![](picture/Pasted%20image%2020240509103054.png)

在龙芯架构中,每一个页表项存放了相邻的一对奇偶相邻页表信息,所以 TLB 页表项中存放虚页号的是系统中虚页号/2 的内容,即虚页号的最低位不需要存放在 TLB 中。查找 TLB 时在根据被查找虚页号的最低位决定是选择奇数号页还是偶数号页的物理转换信息。

Loongarch 架构同样支持基本页表和大页页表的设计，其表项格式如下所示：
![](pirctrue/Pasted%20image%2020240509103251.png)

部分掩码的含义相对其他架构有所不同：
- PTE_MAT ：存储访问类型。龙芯有3种存储访问类型，分别是一致可缓存、强序非缓存和弱序非缓存；**缓存**类型表示Cache和存储类型一致，非缓存类型需要直接访问目的地址。3种状态分别用0-2表示，3保留。
- PTE_PLV ：特权级别。
- PTE_P ：物理页面存在。
- PTE_NR ：不可读，一般不作为访问判断的掩码，而作为异常判断。
- PTE_NX ：不可执行，同上。

## 中断控制系统

龙芯系统采用 CSR.ERA存储异常指令响应地址，使用CSR.CRMD使 CPU 进入最高优先级，根据不同的异常类型执行异常响应。

龙芯指令系统支持中断线的中断传递机制，通过 CSR.CRMD使能位管理局部中断和全局中断。龙芯架构采用固定中断优先级仲裁机制，通过csrxchg指令设置 IE。