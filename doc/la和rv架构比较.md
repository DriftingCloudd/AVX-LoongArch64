## 指令字



# 存储管理系统
存储管理首要的是特权级别的实现，RISC-V采用传统的用户态， 监管态，机器态以及虚拟化模式（可选）实现特权分级，相比之下，Loongarch 架构在虚拟化模式之外采用PLV0-PLV3的特权等级，使用PLV0表示核心态，拥有特权控制命令的权限；一般使用PLV3表示用户态。

PLV1-3都没有使用特权控制命令的权限，3者的区别在于映射翻译模式下的权限不同。Loongarch 架构的MMU采用2种翻译模式，分别是**直接翻译模式** 和 **映射翻译模式**；在直接翻译模式下，如对IOCSR 的控制，物理地址等同于虚拟地址的低$[PALEN-1:0]$位。

翻译模式的选择由CSR中CRMD域选择控制：
- DA=1,PG=0,直接地址翻译模式
- DA=1,PG=1,映射地址翻译模式

## 物理页分配空间
使用$PALEN$表示物理地址最大值，在LA64架构下，$PALEN$ 大小不超过60, 高大于等于4位空间用于执行地址映射。

## 映射地址翻译模式
映射地址翻译模式分为：直接映射地址翻译模式和**页表地址翻译模式**，目前采用的是LA64架构下的直接映射翻译模式。该模式下，Loongarch架构存在4个**映射窗口**：DWM0-DWM3。前2个窗口可用于load/store 操作和 *取指操作*， 后2个窗口用于load/store 操作。

明显，每种窗口匹配的大小是$2^{PALEN}$，高位用于判断命中哪一种映射窗口，从而将在页表映射不合法的虚地址映射到物理地址空间中。

![](assets/Pasted%20image%2020240508170929.png)

## 页表
Loongarch 架构下的页表分为比较部分和物理转换部分，如下图所示：
![](assets/Pasted%20image%2020240508182241.png)

VPPN：虚双页号。在龙芯架构中,每一个页表项存放了**相邻的一对奇偶相邻页**表信息,所以 TLB 页表项中存放虚页号的是系统中虚页号/2 的内容,即虚页号的最低位不需要存放在 TLB 中。查找 TLB 时在根据被查找虚页号的最低位决定是选择奇数号页还是偶数号页的物理转换信息。

**在RISC-V**架构下，采用 *传统的单页表模式*， 每个页表项存储了一个虚拟页号到物理页号的映射关系。有这样的区别，Loongarch 的单页表项实际对应2个物理页，也如上所示。

## 物理转换部分
页表掩码在虚存映射，如`walk` 函数或页表初始化的权限设置都起限制作用。从上图中不难看出Loongarch架构下掩码分别为：

| 掩码类型 | 作用                                 |
| ---- | ---------------------------------- |
| RPLV | 受限特权等级使能，页表项是否*仅* 被对应特权等级的程序访问的控制位 |
| PLV  | 特权级别                               |
| MAT  | 存储访问类型                             |
| NX   | 不可执行                               |
| NR   | 不可读                                |
| D    | 脏位，同 RISCV                         |
| V    | 有效位，同 RISCV                        |
| P    | 物理页存在                              |
| W    | 可写                                 |

类似的，RISC-V主要掩码分别为：

| 掩码类型 | 作用                  |
| ---- | ------------------- |
| V    | 有效位                 |
| R    | 可读                  |
| W    | 可写                  |
| X    | 可执行                 |
| U    | 特权等级为用户态            |
| G    | 表示全局页面              |
| A    | 表示页面是否被访问过（ACCESSD） |
| D    | 脏位                  |
### 掩码位置
根据Loongarch 页表权限设置的位置不同，将掩码分为低位掩码和高位掩码，以LA64 基本页表模式（与大页区分）举例：
![](assets/Pasted%20image%2020240508185358.png)

在掩码基础上，两种架构判断页表项是否是非页子结点的空项的方式可以不同：


| RISC-V                                                    | Loongarch                                    |
| --------------------------------------------------------- | -------------------------------------------- |
| `(pte & PTE_V) && (pte & (PTE_R \| PTE_W \| PTE_X)) == 0` | `(pte & PTE_V) && (PTE_FLAGS(pte) == PTE_V)` |

### 页表数
采用页表映射翻译模式时，根据实际页表层数查询。RISC-V `Rv39` 页表结构采用三级页表，Loongarch 架构采用4级页表：

![](assets/Pasted%20image%2020240508185805.png)

## 比较部分
除VPPN(虚双页号外), TLB比较部分表相包括:
- PS: 在大页表中存在, 用于表示页大小
- ASID: 地址空间标志, **10bit**. 标识区分不同进程中同样的虚地址,避免进程切换时清空整个TLB 所带来的性能损失. 实现方式是为每个进程分配唯一的ASID.
- G: 全局标志位, 当G=1时,查找时不进行ASID 是否一致性的检查, 用于将所有进程设置为共享同一虚拟地址.
- E: 存在位, 表示TLB表项非空

